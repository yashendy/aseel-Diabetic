<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª USDA Ù„Ù„Ø£ØµÙ†Ø§Ù (Ø£Ø¯Ù…Ù†)</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo="><!-- Ù„Ù…Ù†Ø¹ 404 Ø¹Ù„Ù‰ favicon -->
  <style>
    :root{--bg:#0b1220;--card:#0f172a;--line:#1e293b;--muted:#94a3b8;--fg:#eef3ff;--accent:#22c55e}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--fg); margin:0; padding:24px}
    h1{font-size:20px; margin:0 0 12px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin-bottom:16px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    label{font-size:14px; color:#cbd5e1}
    input[type="file"]{padding:8px; background:var(--bg); color:#e2e8f0; border:1px dashed #334155; border-radius:10px}
    button{background:var(--accent); color:#06220f; border:0; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600}
    button.ghost{background:var(--bg); color:#93c5fd; border:1px solid #334155}
    .muted{color:var(--muted); font-size:12px}
    .progress{height:8px; background:var(--bg); border:1px solid #334155; border-radius:9999px; overflow:hidden}
    .bar{height:100%; width:0%; background:var(--accent); transition:width .2s}
    pre{max-height:280px; overflow:auto; background:#020617; border:1px solid var(--line); padding:12px; border-radius:10px; margin:8px 0 0}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #334155; border-radius:9999px; font-size:12px; color:#cbd5e1; text-decoration:none}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>ğŸ—‚ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª USDA Ù„Ù„Ø£ØµÙ†Ø§Ù (Ø£Ø¯Ù…Ù†)</h1>

  <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆØ« -->
  <div class="card" id="authCard">
    <div class="row">
      <span class="muted">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„:</span>
      <b id="authState">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</b>
      <span class="muted" id="authHint">Ø§ÙØªØ­ÙŠ admin.html ÙˆØ³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ ÙƒØ£Ø¯Ù…Ù† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†.</span>
    </div>
  </div>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".csv,.json" />
      <button id="run">Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ«</button>
      <a class="tag" href="usda-import-sample.csv" download>Ù‚Ø§Ù„Ø¨ CSV Ø¬Ø§Ù‡Ø²</a>
      <a class="tag" href="diet-templates-samples.json" download>Ù†Ù…Ø§Ø°Ø¬ Ù‚ÙˆØ§Ù„Ø¨ Ø£Ù†Ø¸Ù…Ø© (JSON)</a>
    </div>
    <p class="muted">
      ÙŠÙÙØ¶Ù‘ÙÙ„ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù‚ÙŠÙ… <b>Ù„ÙƒÙ„ 100 Ø¬Ù…</b>. Ø£Ø¹Ù…Ø¯Ø© Ø´Ø§Ø¦Ø¹Ø©: 203 (Protein)ØŒ 204 (Fat)ØŒ 205 (Carbs)ØŒ
      269 (Sugars)ØŒ 291 (Fiber)ØŒ 307 (Sodium)ØŒ 601 (Cholesterol)ØŒ 606 (Sat. Fat)â€¦ Ø¥Ù„Ø®.
    </p>
    <div class="grid">
      <label><input type="radio" name="lookup" value="name" checked> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… (AR/EN)</label>
      <label><input type="radio" name="lookup" value="id"> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù…Ø¹Ø±Ù‘Ù Ø®Ø§Ø±Ø¬ÙŠ (external_id/fdc_id)</label>
    </div>
  </div>

  <!-- ØªÙ‚Ø¯Ù… + Ù„ÙˆØ¬ -->
  <div class="card">
    <div class="row"><div class="progress" style="flex:1"><div id="bar" class="bar"></div></div><span id="pct" class="muted">0%</span></div>
    <pre id="log">â€¦ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</pre>
  </div>

  <!-- Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ -->
  <div class="card">
    <div class="row">
      <button id="dry">ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ (Dry Run)</button>
      <button id="save" class="ghost">Ø­ÙØ¸ Ø§Ù„Ø£Ø¹Ù„Ø§Ù… ÙÙ‚Ø· (dietFlags)</button>
    </div>
    <p class="muted">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙŠØ¹Ø±Ø¶ Ù…Ø§ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ø¯ÙˆÙ† ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
  </div>

  <!-- Firebase (ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ firebase-config.js Ø¨ØªØ§Ø¹Ùƒ) -->
  <script type="module">
    // âœ… Ù…Ù‡Ù…: ØªØ£ÙƒØ¯ÙŠ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± ØµØ­ÙŠØ­ ÙˆÙŠÙØµØ¯Ù‘Ø± { db, auth }
    import { db, auth } from "./js/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Ø¹Ù†Ø§ØµØ±
    const $file = document.getElementById('file');
    const $run  = document.getElementById('run');
    const $dry  = document.getElementById('dry');
    const $saveFlags = document.getElementById('save');
    const $log  = document.getElementById('log');
    const $bar  = document.getElementById('bar');
    const $pct  = document.getElementById('pct');
    const $authState = document.getElementById('authState');

    // Ù„ÙˆØ¬ + Ø¨Ø±ÙˆØ¬Ø±ÙØ³
    function log(line){ $log.textContent += "\\n" + line; $log.scrollTop = $log.scrollHeight; }
    function setProgress(i, n){
      const p = n ? Math.round((i/n)*100) : 0;
      $bar.style.width = p + '%'; $pct.textContent = p + '%';
    }

    // CSV
    function parseCSV(text){
      const rows = [];
      const lines = text.split(/\\r?\\n/);
      const head = lines.shift();
      if(!head) return rows;
      const headers = head.split(',').map(h=>h.trim());
      for(const line of lines){
        if(!line.trim()) continue;
        const cells = line.split(',').map(c=>c.trim());
        const o = {};
        headers.forEach((h,i)=> o[h] = cells[i] ?? '');
        rows.push(o);
      }
      return rows;
    }

    // ØªØ­ÙˆÙŠÙ„ ØµÙ USDA â†’ nutrMapUSDA
    function toNutrMapUSDA(row){
      const ids = ["203","204","205","269","291","307","601","606","301","303","306","320","401","328","323"];
      const labels = {
        "203":"Ø¨Ø±ÙˆØªÙŠÙ†","204":"Ø¯Ù‡ÙˆÙ†","205":"ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª","269":"Ø³ÙƒØ±","291":"Ø£Ù„ÙŠØ§Ù",
        "307":"ØµÙˆØ¯ÙŠÙˆÙ…","601":"ÙƒÙˆÙ„ÙŠØ³ØªØ±ÙˆÙ„","606":"Ø¯Ù‡ÙˆÙ† Ù…Ø´Ø¨Ø¹Ø©","301":"ÙƒØ§Ù„Ø³ÙŠÙˆÙ…",
        "303":"Ø­Ø¯ÙŠØ¯","306":"Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…","320":"Vit A","401":"Vit C","328":"Vit D","323":"Vit E"
      };
      const units = { "203":"g","204":"g","205":"g","269":"g","291":"g","307":"mg","601":"mg","606":"g","301":"mg","303":"mg","306":"mg","320":"Âµg","401":"mg","328":"Âµg","323":"mg" };
      const map = {};
      for(const id of ids){
        const val = Number(row[id] ?? '');
        if(Number.isFinite(val)) map[id] = { label_ar: labels[id]||id, unit: units[id]||'', per100: val };
      }
      return map;
    }

    // Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø£Ø¹Ù„Ø§Ù… Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
    function computeDietFlagsFromUSDA(n){
      const get=(id,d=0)=> Number(n?.[id]?.per100 ?? d);
      const sugar=get("269"), carbs=get("205"), fat=get("204"), sat=get("606"), na=get("307"), chol=get("601");
      return {
        low_sugar:  sugar <= 5,
        low_carb:   carbs <= 10,
        low_fat:    fat   <= 3,
        low_satfat: sat   <= 1.5,
        low_sodium: na    <= 120,
        low_chol:   chol  <= 20
      };
    }

    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù
    async function findByName(name_ar, name_en){
      const name = (name_ar || name_en || '').trim();
      if(!name) return null;
      const col = collection(db, "admin/global/foodItems");
      const qs = await getDocs(query(col, where("name","==", name)));
      return qs.docs[0] ?? null;
    }
    async function findByExternalId(extId){
      const col = collection(db, "admin/global/foodItems");
      const qs = await getDocs(query(col, where("external_id","==", String(extId))));
      return qs.docs[0] ?? null;
    }

    // Gate: Ù„Ø§Ø²Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒÙˆÙ† Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„
    let currentUser = null;
    onAuthStateChanged(auth, (u)=>{
      currentUser = u || null;
      $authState.textContent = currentUser ? `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${currentUser.email || currentUser.uid}` : "ØºÙŠØ± Ù…Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„";
    });

    async function ensureAuth(){
      if(!currentUser){
        alert("Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ ÙƒØ£Ø¯Ù…Ù† Ø£ÙˆÙ„Ù‹Ø§ Ù…Ù† admin.html (Ù†ÙØ³ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†) Ø«Ù… Ø§Ø±Ø¬Ø¹ÙŠ Ù‡Ù†Ø§.");
        throw new Error("AUTH_REQUIRED");
      }
    }

    // Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
    async function runImport({dryRun=false, flagsOnly=false}){
      await ensureAuth();

      const f = $file.files?.[0];
      if(!f){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹"); return; }

      const text = await f.text();
      const rows = f.name.endsWith('.json') ? JSON.parse(text) : parseCSV(text);
      $log.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦'; setProgress(0, rows.length);

      let ok=0, fail=0, i=0;
      const byId = document.querySelector('input[name="lookup"]:checked').value === 'id';

      for(const r of rows){
        i++; setProgress(i, rows.length);
        try{
          const nutrMapUSDA = toNutrMapUSDA(r);
          const dietFlags   = computeDietFlagsFromUSDA(nutrMapUSDA);

          const refDoc = byId ? await findByExternalId(r.external_id || r.fdc_id || r.id)
                              : await findByName(r.name_ar, r.name_en);

          if(!refDoc){ fail++; log(`âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${r.name_ar||r.name_en||r.external_id||'??'}`); continue; }

          if(dryRun){ log(`ğŸ›ˆ ÙØ­Øµ: ${refDoc.id} â€” nutrMapUSDA + dietFlags`); continue; }

          const payload = flagsOnly
            ? { dietFlags, updatedAt: new Date().toISOString() }
            : { nutrMapUSDA, dietFlags, updatedAt: new Date().toISOString() };

          await updateDoc(doc(db, "admin/global/foodItems", refDoc.id), payload);
          ok++; log(`âœ… ØªÙ…: ${r.name_ar||r.name_en||refDoc.id}`);
        }catch(e){
          fail++; log(`âš ï¸ Ø®Ø·Ø£: ${(r.name_ar||r.name_en)||'??'} â€” ${e.message||e}`);
        }
      }
      log('\\nâ€” Ø§ÙƒØªÙ…Ù„ â€”');
      log(`âœ”ï¸ Ù†Ø¬Ø§Ø­: ${ok} â€” âŒ ÙØ´Ù„: ${fail}`);
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('run').addEventListener('click', ()=> runImport({dryRun:false, flagsOnly:false}));
    document.getElementById('dry').addEventListener('click', ()=> runImport({dryRun:true,  flagsOnly:false}));
    document.getElementById('save').addEventListener('click', ()=> runImport({dryRun:false, flagsOnly:true}));

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø±Ø³Ø§Ø¦Ù„ "A listener indicated an asynchronous response..." Ø¬Ø§ÙŠØ© Ù…Ù† Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ù…ØªØµÙØ­.
    // Ù„Ùˆ Ø¸Ù‡Ø±ØªØŒ Ø¬Ø±Ù‘Ø¨ÙŠ Incognito Ø£Ùˆ Ø¹Ø·Ù‘Ù„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øªâ€”Ù…Ø´ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„ØµÙØ­Ø©.
  </script>
</body>
</html>
