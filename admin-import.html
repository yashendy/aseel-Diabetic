<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª USDA Ù„Ù„Ø£ØµÙ†Ø§Ù (Ø£Ø¯Ù…Ù†)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#0b1220; color:#eef3ff; margin:0; padding:24px}
    h1{font-size:20px; margin:0 0 12px}
    .card{background:#0f172a; border:1px solid #1e293b; border-radius:14px; padding:16px; margin-bottom:16px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    label{font-size:14px; color:#cbd5e1}
    input[type="file"]{padding:8px; background:#0b1220; color:#e2e8f0; border:1px dashed #334155; border-radius:10px}
    button{background:#22c55e; color:#06220f; border:0; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:600}
    button.ghost{background:#0b1220; color:#93c5fd; border:1px solid #334155}
    .muted{color:#94a3b8; font-size:12px}
    .progress{height:8px; background:#0b1220; border:1px solid #334155; border-radius:9999px; overflow:hidden}
    .bar{height:100%; width:0%; background:#22c55e; transition:width .2s}
    pre{max-height:280px; overflow:auto; background:#020617; border:1px solid #1e293b; padding:12px; border-radius:10px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .tag{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid #334155; border-radius:9999px; font-size:12px; color:#cbd5e1}
  </style>
</head>
<body>
  <h1>ğŸ—‚ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª USDA Ù„Ù„Ø£ØµÙ†Ø§Ù (Ø£Ø¯Ù…Ù†)</h1>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".csv,.json" />
      <button id="run">Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ«</button>
      <!-- Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¯Ù‘Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· -->
      <a class="tag" href="usda-import-sample.csv" download>Ù‚Ø§Ù„Ø¨ CSV Ø¬Ø§Ù‡Ø²</a>
      <a class="tag" href="diet-templates-samples.json" download>Ù†Ù…Ø§Ø°Ø¬ Ù‚ÙˆØ§Ù„Ø¨ Ø£Ù†Ø¸Ù…Ø© (JSON)</a>
    </div>
    <p class="muted">
      Ø§Ù„Ù‚ÙŠÙ… ÙŠÙÙØ¶Ù‘Ù„ ØªÙƒÙˆÙ† <b>Ù„ÙƒÙ„ 100 Ø¬Ù…</b>. Ø£Ø¹Ù…Ø¯Ø© Ø´Ø§Ø¦Ø¹Ø©: 203 (Protein)ØŒ 204 (Fat)ØŒ 205 (Carbs)ØŒ 269 (Sugars)ØŒ
      291 (Fiber)ØŒ 307 (Sodium)ØŒ 601 (Cholesterol)ØŒ 606 (Sat. Fat) â€¦ Ø¥Ù„Ø®.
    </p>
    <div class="grid">
      <label><input type="radio" name="lookup" value="name" checked> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ø§Ø³Ù… (AR/EN)</label>
      <label><input type="radio" name="lookup" value="id"> Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù…Ø¹Ø±Ù‘Ù Ø®Ø§Ø±Ø¬ÙŠ (external_id/fdc_id)</label>
    </div>
  </div>

  <div class="card">
    <div class="row"><div class="progress" style="flex:1"><div id="bar" class="bar"></div></div><span id="pct" class="muted">0%</span></div>
    <pre id="log">â€¦ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù</pre>
  </div>

  <div class="card">
    <div class="row">
      <button id="dry">ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ (Dry Run)</button>
      <button id="save" class="ghost">Ø­ÙØ¸ Ø§Ù„Ø£Ø¹Ù„Ø§Ù… ÙÙ‚Ø· (dietFlags)</button>
    </div>
    <p class="muted">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ ÙŠØ¹Ø±Ø¶ Ù…Ø§ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¨Ø¯ÙˆÙ† ÙƒØªØ§Ø¨Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
  </div>

  <!-- Firebase Firestore (ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ firebase-config.js Ø¨ØªØ§Ø¹Ùƒ) -->
  <script type="module">
    import { db } from "./js/firebase-config.js";
    import { collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $file = document.getElementById('file');
    const $run  = document.getElementById('run');
    const $log  = document.getElementById('log');
    const $bar  = document.getElementById('bar');
    const $pct  = document.getElementById('pct');
    const $dry  = document.getElementById('dry');
    const $saveFlags = document.getElementById('save');

    function log(line){ $log.textContent += "\\n" + line; $log.scrollTop = $log.scrollHeight; }
    function setProgress(i, n){
      const p = n ? Math.round((i/n)*100) : 0;
      $bar.style.width = p + '%'; $pct.textContent = p + '%';
    }

    function parseCSV(text){
      const rows = [];
      const lines = text.split(/\\r?\\n/);
      const head = lines.shift();
      if(!head){ return rows; }
      const headers = head.split(',').map(h=>h.trim());
      for(const line of lines){
        if(!line.trim()) continue;
        const cells = line.split(',').map(c=>c.trim());
        const o = {};
        headers.forEach((h,i)=> o[h] = cells[i] ?? '');
        rows.push(o);
      }
      return rows;
    }

    function toNutrMapUSDA(row){
      const ids = ["203","204","205","269","291","307","601","606","301","303","306","320","401","328","323"];
      const labels = {
        "203":"Ø¨Ø±ÙˆØªÙŠÙ†","204":"Ø¯Ù‡ÙˆÙ†","205":"ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª","269":"Ø³ÙƒØ±","291":"Ø£Ù„ÙŠØ§Ù",
        "307":"ØµÙˆØ¯ÙŠÙˆÙ…","601":"ÙƒÙˆÙ„ÙŠØ³ØªØ±ÙˆÙ„","606":"Ø¯Ù‡ÙˆÙ† Ù…Ø´Ø¨Ø¹Ø©","301":"ÙƒØ§Ù„Ø³ÙŠÙˆÙ…",
        "303":"Ø­Ø¯ÙŠØ¯","306":"Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…","320":"Vit A","401":"Vit C","328":"Vit D","323":"Vit E"
      };
      const units = { "203":"g","204":"g","205":"g","269":"g","291":"g","307":"mg","601":"mg","606":"g","301":"mg","303":"mg","306":"mg","320":"Âµg","401":"mg","328":"Âµg","323":"mg" };
      const map = {};
      for(const id of ids){
        const val = Number(row[id] ?? '');
        if(Number.isFinite(val)){
          map[id] = { label_ar: labels[id] || id, unit: units[id] || '', per100: val };
        }
      }
      return map;
    }

    function computeDietFlagsFromUSDA(n){
      const get=(id,d=0)=> Number(n?.[id]?.per100 ?? d);
      const sugar=get("269"), carbs=get("205"), fat=get("204"), sat=get("606"), na=get("307"), chol=get("601");
      return {
        low_sugar:  sugar <= 5,
        low_carb:   carbs <= 10,
        low_fat:    fat   <= 3,
        low_satfat: sat   <= 1.5,
        low_sodium: na    <= 120,
        low_chol:   chol  <= 20
        // Ù†Ø¨Ø§ØªÙŠ/Ù†Ø¨Ø§ØªÙŠ ØµØ§Ø±Ù…/Ø®Ø§Ù„Ù Ù…Ù† Ø§Ù„Ø¬Ù„ÙˆØªÙŠÙ†: ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£Ùˆ Ù…Ù† ÙØ¦Ø©/Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
      };
    }

    async function findByName(name_ar, name_en){
      const name = (name_ar || name_en || '').trim();
      if(!name) return null;
      const col = collection(db, "admin/global/foodItems");
      const qs = await getDocs(query(col, where("name","==", name)));
      return qs.docs[0] ?? null;
    }

    async function findByExternalId(extId){
      const col = collection(db, "admin/global/foodItems");
      const qs = await getDocs(query(col, where("external_id","==", String(extId))));
      return qs.docs[0] ?? null;
    }

    async function runImport({dryRun=false, flagsOnly=false}){
      const f = $file.files?.[0];
      if(!f){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const text = await f.text();
      const rows = f.name.endsWith('.json') ? JSON.parse(text) : parseCSV(text);
      $log.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦'; setProgress(0, rows.length);

      let ok=0, fail=0, i=0;
      const byId = document.querySelector('input[name="lookup"]:checked').value === 'id';

      for(const r of rows){
        i++; setProgress(i, rows.length);

        try{
          const nutrMapUSDA = toNutrMapUSDA(r);
          const dietFlags = computeDietFlagsFromUSDA(nutrMapUSDA);

          const refDoc = byId ? await findByExternalId(r.external_id || r.fdc_id || r.id)
                              : await findByName(r.name_ar, r.name_en);
          if(!refDoc){ fail++; log(`âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${r.name_ar||r.name_en||r.external_id||'??'}`); continue; }

          if(dryRun){
            log(`ğŸ›ˆ ÙØ­Øµ: ${refDoc.id} â€” Ø³ÙŠØªÙ… Ø­ÙØ¸ nutrMapUSDA + dietFlags`);
            continue;
          }

          const payload = flagsOnly ? { dietFlags, updatedAt: new Date().toISOString() }
                                    : { nutrMapUSDA, dietFlags, updatedAt: new Date().toISOString() };

          await updateDoc(doc(db, "admin/global/foodItems", refDoc.id), payload);
          ok++; log(`âœ… ØªÙ…: ${r.name_ar||r.name_en||refDoc.id}`);
        }catch(e){
          fail++; log(`âš ï¸ Ø®Ø·Ø£: ${(r.name_ar||r.name_en)||'??'} â€” ${e}`);
        }
      }
      log('\\nâ€” Ø§ÙƒØªÙ…Ù„ â€”');
      log(`âœ”ï¸ Ù†Ø¬Ø§Ø­: ${ok} â€” âŒ ÙØ´Ù„: ${fail}`);
    }

    document.getElementById('run').addEventListener('click', ()=> runImport({dryRun:false, flagsOnly:false}));
    document.getElementById('dry').addEventListener('click', ()=> runImport({dryRun:true, flagsOnly:false}));
    document.getElementById('save').addEventListener('click', ()=> runImport({dryRun:false, flagsOnly:true}));
  </script>
</body>
</html>
