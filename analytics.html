<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>التحاليل</title>
  <link rel="stylesheet" href="./css/analytics.css" />

  <!-- Chart.js + adapter للوقت -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>
<body>
  <div class="wrap">
    <!-- شريط علوي -->
    <header class="topbar">
      <div class="left chips" id="childChips"></div>

      <div class="right controls">
        <div class="range">
          <label class="field">
            <span>من</span>
            <input type="date" id="fromDate">
          </label>
          <label class="field">
            <span>إلى</span>
            <input type="date" id="toDate">
          </label>

          <div class="quick-range">
            <button class="chip" data-days="7">7 أيام</button>
            <button class="chip" data-days="14">14</button>
            <button class="chip" data-days="30">30</button>
            <button class="chip" data-days="90">90</button>
          </div>
        </div>

        <label class="field">
          <span>وحدة العرض</span>
          <select id="unitSelect">
            <option value="mmol/L">mmol/L</option>
            <option value="mg/dL">mg/dL</option>
          </select>
        </label>

        <div class="actions">
          <button id="btnBack" class="btn btn--ghost">رجوع للتقرير</button>
          <button id="btnRefresh" class="btn">تحديث</button>
          <button id="btnSaveLine" class="btn">حفظ الرسم الزمني</button>
          <button id="btnSavePie" class="btn">حفظ نسب النطاق</button>
        </div>
      </div>
    </header>

    <!-- ملخص -->
    <section class="sheet meta">
      <div class="line">
        <strong id="childName">—</strong>
        <span class="muted" id="childMeta">—</span>
      </div>
      <div class="line">
        الفترة: <b id="periodFrom">—</b> إلى <b id="periodTo">—</b>
      </div>
      <div class="cards">
        <div class="card"><span class="k">عدد القراءات</span><b id="stCount">—</b></div>
        <div class="card"><span class="k">المتوسط</span><b id="stAvg">—</b></div>
        <div class="card"><span class="k">الانحراف (SD)</span><b id="stSD">—</b></div>
        <div class="card"><span class="k">CV%</span><b id="stCV">—</b></div>
        <div class="card b-ok"><span class="k">TIR</span><b id="stTIR">—</b></div>
        <div class="card b-low"><span class="k">TBR</span><b id="stTBR">—</b></div>
        <div class="card b-high"><span class="k">TAR</span><b id="stTAR">—</b></div>
      </div>
    </section>

    <!-- الرسوم -->
    <main class="grid-2">
      <!-- الرسم الزمني -->
      <section class="panel">
        <div class="panel-head">
          <h3>الرسم الزمني للقراءات</h3>
          <div id="lineLegend" class="legend"></div>
        </div>

        <div id="spinnerLine" class="spinner" hidden></div>
        <div id="errLine" class="error" hidden></div>

        <canvas id="dayChart" height="240" aria-label="الرسم الزمني"></canvas>

        <div class="limits">
          <span class="chip chip-dot dot-low">الحد الحرج المنخفض (Severe Low): <b id="sevLowLbl">—</b></span>
          <span class="chip chip-dot dot-high">الحد الحرج المرتفع (Severe High): <b id="sevHighLbl">—</b></span>
        </div>
      </section>

      <!-- نسب الوقت داخل/خارج النطاق -->
      <section class="panel">
        <div class="panel-head">
          <h3>نِسَب الوقت داخل/خارج النطاق</h3>
          <div id="pieLegend" class="legend"></div>
        </div>

        <div id="spinnerPie" class="spinner" hidden></div>
        <div id="errPie" class="error" hidden></div>

        <canvas id="rangePie" height="240" aria-label="نِسَب الوقت"></canvas>
      </section>
    </main>

    <div id="toast" class="toast" style="display:none"></div>
  </div>

  <!-- Firebase config (ESM يصدّر auth/db) -->
  <script type="module" src="./js/analytics.js"></script>
</body>
</html>
