<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุฌุจุฉ ุงูุทูู</title>
  <link rel="stylesheet" href="./css/meals.css" />
</head>
<body>

  <header class="page-header">
    <div class="left">
      <button id="btnBack" class="btn ghost">โฌ๏ธ ุฑุฌูุน</button>
      <a href="./child.html" class="btn ghost">๐ ุงูุฑุฆูุณูุฉ</a>
    </div>
    <div class="title">
      <h1>ูุฌุจุฉ ุงูุทูู <span id="childName" class="chip chip-soft">โ</span></h1>
      <div class="chips">
        <span id="chipUnit" class="chip">ูุญุฏุฉ: โ</span>
        <span id="chipCR" class="chip">CR: โ</span>
        <span id="chipCF" class="chip">CF: โ</span>
      </div>
    </div>
    <div class="right"></div>
  </header>

  <section class="toolbar">
    <div class="field">
      <label>ููุน ุงููุฌุจุฉ</label>
      <select id="mealType">
        <option value="ูุทุงุฑ">ูุทุงุฑ</option>
        <option value="ุบุฏุง">ุบุฏุง</option>
        <option value="ุนุดุง">ุนุดุง</option>
        <option value="ุณูุงู">ุณูุงู</option>
      </select>
    </div>

    <div class="field">
      <label>ุชุงุฑูุฎ</label>
      <input id="mealDate" type="date" />
    </div>

    <div class="field">
      <label>ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ</label>
      <div class="row gap">
        <button id="btnAddFromLib" class="btn">+ ุฅุถุงูุฉ ุตูู ูู ุงูููุชุจุฉ</button>
        <button id="btnAddFromPreset" class="btn ghost">๐ฆ ูู ูุงูุจ</button>
        <button id="btnSaveAsPreset" class="btn ghost">โญ ุญูุธ ููุฌุจุฉ ุฌุงูุฒุฉ</button>
      </div>
    </div>
  </section>

  <section class="metrics-card card">
    <div class="metrics-grid">
      <div class="field">
        <label>ููุงุณ ูุจู ุงููุฌุจุฉ</label>
        <input id="preReading" type="number" step="0.1" inputmode="decimal" placeholder="โ" />
      </div>
      <div class="field">
        <label>ููุงุณ ุจุนุฏ ุงููุฌุจุฉ</label>
        <input id="postReading" type="number" step="0.1" inputmode="decimal" placeholder="โ" />
      </div>

      <div class="field">
        <label>ุฌุฑุนุฉ ุงูุชุตุญูุญ</label>
        <input id="doseCorrection" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>
      <div class="field">
        <label>ุฌุฑุนุฉ ุงููุงุฑุจ (ููุชุฑุญุฉ)</label>
        <input id="doseCarb" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>

      <div class="field">
        <label>ุฅุฌูุงูู ุงูุฌุฑุนุฉ</label>
        <input id="doseTotal" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>

      <div class="field">
        <label>ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
        <input id="notes" type="text" placeholder="ูุซุงู: ูุฌุจุฉ ุฎูููุฉ" />
      </div>
    </div>

    <div id="hintLine" class="hint-line">
      <span id="hintCf" class="muted">โ๏ธ ุฑุฌุงุก ุถุจุท CF (ูุนุงูู ุงูุชุตุญูุญ) ูู ุจูุงูุงุช ุงูุทูู.</span>
      <span id="hintCr" class="muted">โ๏ธ ุฑุฌุงุก ุถุจุท CR (ูุนุงูู ุงููุงุฑุจ) ูู ุจูุงูุงุช ุงูุทูู.</span>
      <span id="hintAuto" class="muted">โ ุชู ุฌูุจ ุงูููุงุณ ุชููุงุฆููุง ุฅุฐุง ุชููุฑ.</span>
    </div>
  </section>

  <section class="targets card">
    <div class="targets-head">
      <div>
        <strong>ูุฏู ุงููุงุฑุจ ูููุฌุจุฉ:</strong>
        <span id="targetText" class="chip chip-soft">โ</span>
      </div>
      <div class="row gap">
        <button id="btnAdjustToTarget" class="btn small">๐ฏ ุถุจุท ูููุฏู</button>
        <button id="btnSmartDistribute" class="btn small ghost">๐ ุชูุฒูุน ุฐูู</button>
      </div>
    </div>
    <div class="progress">
      <div id="progressFill"></div>
    </div>
    <div class="progress-caption">
      <span>ุงููุงุฑุจ ุงูุญุงูู: <b id="netCarb">0</b> g</span>
      <span>ุงูุณุนุฑุงุช: <b id="totalCal">0</b> kcal</span>
      <span>ุจุฑูุชูู: <b id="totalProt">0</b> g</span>
      <span>ุฏููู: <b id="totalFat">0</b> g</span>
    </div>
  </section>

  <section class="card">
    <div class="table-head">
      <div class="th th-actions">โ</div>
      <div class="th th-name">ุงูุตูู</div>
      <div class="th th-est">ุงูุชูุฏูุฑ ุงูุจูุชู</div>
      <div class="th th-qty">ุงููููุฉ</div>
      <div class="th th-grams">ุงูุฌุฑุงูุงุช (g)</div>
      <div class="th">ูุงุฑุจ (g)</div>
      <div class="th">ุจุฑูุชูู (g)</div>
      <div class="th">ุฏููู (g)</div>
      <div class="th">ุณุนุฑุงุช (kcal)</div>
    </div>
    <div id="itemsBody" class="items-body"></div>
    <div class="table-foot">
      <div class="sum">ุงูุฅุฌูุงูู: ูุงุฑุจ <b id="sumCarb">0</b> โข ุจุฑูุชูู <b id="sumProt">0</b> โข ุฏููู <b id="sumFat">0</b> โข ุณุนุฑุงุช <b id="sumCal">0</b></div>
    </div>
  </section>

  <section class="save-row">
    <div class="row gap">
      <button id="btnSaveMeal" class="btn primary">๐พ ุญูุธ ุงููุฌุจุฉ</button>
      <button id="btnReset" class="btn ghost">โบ ุฅุนุงุฏุฉ ุงูุถุจุท</button>
    </div>
  </section>

  <!-- ููุชุจุฉ ุงูุฃุตูุงู -->
  <dialog id="dlgLibrary" class="modal">
    <div class="modal-head">
      <h3>ุงุฎุชูุงุฑ ุตูู ูู ุงูููุชุจุฉ</h3>
      <button class="icon" data-close>โ</button>
    </div>
    <div class="modal-tools">
      <input id="libSearch" type="search" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู #ูุงุดุชุงุฌโฆ" />
      <label class="chk"><input id="fltLiked" type="checkbox" /> โค๏ธ ููุท ุงูููุถูุฉ</label>
      <label class="chk"><input id="fltHideDiet" type="checkbox" checked /> ุฅุฎูุงุก ุงููุฎุงูู ูููุธุงู โ๏ธ</label>
      <label class="chk"><input id="fltHideAllergy" type="checkbox" checked /> ุฅุฎูุงุก ุงูุญุณุงุณูุฉ ๐ซ</label>
    </div>
    <div id="libGrid" class="grid"></div>
  </dialog>

  <!-- ุงูููุงูุจ -->
  <dialog id="dlgPresets" class="modal">
    <div class="modal-head">
      <h3>ููุงูุจ ุงููุฌุจุงุช</h3>
      <button class="icon" data-close>โ</button>
    </div>
    <div id="presetsList" class="grid"></div>
  </dialog>

  <!-- ุงููุณุงุนุฏ ุงูุฐูู -->
  <button id="btnAssistant" class="assistant-fab">๐ฌ</button>
  <div id="assistantPanel" class="assistant hidden">
    <div class="assistant-head">
      <strong>ุงููุณุงุนุฏ ุงูุฐูู</strong>
      <button id="assistantClose" class="icon">โ</button>
    </div>
    <div id="assistantBody" class="assistant-body"></div>
    <div class="assistant-foot">
      <button class="btn small" data-ask="ูู ุฃุญุชุงุฌ ุฌุฑุนุฉ ุชุตุญูุญุ">ูู ุฃุญุชุงุฌ ุชุตุญูุญุ</button>
      <button class="btn small" data-ask="ููู ุฃูุตู ููุฏู ุงููุฌุจุฉุ">ููู ุฃูุตู ููุฏููุ</button>
      <button class="btn small" data-ask="ูู ูู ูุฎุงููุฉ ุฃู ุญุณุงุณูุฉุ">ุงููุฎุงูู/ุงูุญุณุงุณูุฉุ</button>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase (modular CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged as modOnAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ูุญุฑู ุชููุฆุฉ ูุฑู: __FB ุฌุงูุฒุฉ โ ูุณุชุฎุฏููุงุ ุฃู firebaseConfig ููุฌูุฏ โ ููููุฆุ
    // ุฃู compat ููุฌูุฏ โ ูุณุชุฎุฏููุ ูุฅูุง ูุนุฑุถ ุฑุณุงูุฉ ูุทููุฉ ุจุฏู ุงููุฑุงุด.
    let app, auth, db, storage, onAuthStateChanged;

    const useFromWindow = () => {
      app = window.__FB?.app; auth = window.__FB?.auth;
      db = window.__FB?.db; storage = window.__FB?.storage;
      onAuthStateChanged = window.__FB?.onAuthStateChanged || modOnAuth;
      return Boolean(app && auth && db && storage);
    };

    const tryConfig = () => {
      const cfg = window.firebaseConfig || window.FIREBASE_CONFIG;
      if(!cfg) return false;
      app = initializeApp(cfg);
      auth = getAuth(app); db = getFirestore(app); storage = getStorage(app);
      onAuthStateChanged = modOnAuth;
      return true;
    };

    const tryCompat = () => {
      const f = window.firebase;
      if(!f || !f.apps || !f.apps.length) return false;
      app = f.app(); auth = f.auth(); db = f.firestore(); storage = f.storage();
      onAuthStateChanged = (a, cb)=> auth.onAuthStateChanged(cb);
      return true;
    };

    if(!useFromWindow() && !tryConfig() && !tryCompat()){
      console.error("Firebase config ุบูุฑ ูุชููุฑ. ุฑุฌุงุก ุชุถููู firebaseConfig ุฃู __FB ุฃู compat.");
    }

    window.__FB = { app, auth, db, storage, onAuthStateChanged };
  </script>

  <script type="module" src="./js/meals.js"></script>
</body>
</html>
