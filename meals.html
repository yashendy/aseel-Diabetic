<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุงููุฌุจุงุช</title>

  <!-- ุฃููููุฉ ุงูููุตุฉ (ุงุฎุชูุงุฑู) -->
  <link rel="icon" href="favicon.png" />

  <!-- ุณุชุงููุงุช ุงูุตูุญุฉ -->
  <link rel="stylesheet" href="css/meals.css" />
  <style>
    /* ูููู ุฅุจูุงุก ูุฐุง ุงููุณู ุฃู ุญุฐูู ูู ุนูุฏู ููู CSS ูููุตู ููุท */
  </style>
</head>
<body>

  <!-- ููุฏุฑ ุนุงู -->
  <div id="appLoader" class="app-loader">
    <div class="box">
      <span class="spinner"></span>
      <span>ูุฌุฑู ุงูุชุญูููโฆ</span>
    </div>
  </div>

  <div class="container">

    <!-- ุฑุฃุณ ุตุบูุฑ: ุงุณู ุงูุทูู ูุงูุดูุจุณ -->
    <div class="card">
      <div class="flex-between">
        <div>
          <div style="font-weight:800;font-size:18px" id="childName">โ</div>
          <div class="chips" style="margin-top:8px;">
            <div class="chip" id="chipCF">CF โ</div>
            <div class="chip" id="chipCR">CR โ</div>
            <div class="chip" id="chipTargets">ูุฏู โ</div>
          </div>
        </div>
        <a id="backToChild" class="btn ghost" href="child.html">ุฑุฌูุน ูุตูุญุฉ ุงูุทูู</a>
      </div>
    </div>

    <!-- ููุญุฉ ุงูููู -->
    <div class="card">
      <div class="grid-left">
        <!-- ุฅุนุฏุงุฏุงุช ุงูููู -->
        <div>
          <h3 style="margin:0 0 10px;">ููุญุฉ ุงูููู</h3>

          <div class="chips" style="gap:12px;margin-bottom:10px;">
            <label>ุงููุฌุจุฉ
              <select id="slotSelect">
                <option value="b">ูุทุงุฑ</option>
                <option value="l">ุบุฏุงุก</option>
                <option value="d">ุนุดุงุก</option>
                <option value="s">ุณูุงู</option>
              </select>
            </label>

            <label>ุชุงุฑูุฎ ุงููุฌุจุฉ
              <input id="dateInput" type="date" />
            </label>

            <label>ููุช ุงููุฌุจุฉ (ูุฑุจุท ุงูููุงุณ)
              <input id="mealTime" type="time" value="13:00" />
            </label>
          </div>

          <div class="chips" style="gap:12px;margin-bottom:10px;">
            <label>ูุฑุงุกุฉ ูุจู ุงููุฌุจุฉ (mmol/L)
              <input id="preBg" type="number" step="0.1" style="width:110px" />
            </label>
            <button id="btnFetchPre" class="btn ghost">ุฌูุจ ุชููุงุฆู</button>
          </div>

          <div class="chips" style="gap:12px;margin-bottom:10px;">
            <label>ูุงุนุฏุฉ ุตุงูู ุงููุงุฑุจ
              <select id="netCarbRule">
                <option value="fullFiber">ุจุฏูู ุฎุตู ุงูุฃููุงู</option>
                <option value="halfFiber">ูุตู ุฎุตู ุงูุฃููุงู</option>
                <option value="none">ุฎุตู ูุงูู ุงูุฃููุงู</option>
              </select>
            </label>
          </div>

          <div class="chips" style="gap:12px;margin-bottom:6px;">
            <label>ุฌุฑุนุฉ ุงูุชุตุญูุญ (U)
              <input id="doseCorrection" type="number" step="0.1" style="width:110px" />
            </label>
            <label>ุฌุฑุนุฉ ุงููุงุฑุจ (U)
              <input id="doseCarbs" type="number" step="0.1" style="width:110px" />
            </label>
            <div class="chip">ุฅุฌูุงูู ูุงุฑุจ ุงูููู: <b id="dayCarbs">0</b> g</div>
          </div>

          <div class="progress">
            <div id="progressBar" class="bar" style="width:0%"></div>
          </div>
          <div id="progressLabel" class="progress-label">0 / โ g</div>

          <div class="toolbar" style="margin-top:8px;">
            <button id="btnScaleToTarget" class="btn">ุงุถุจุท ูููุตูู ูููุฏู</button>
            <button id="btnClearMeal" class="btn danger">ูุณุญ</button>
            <button id="btnOpenLibrary" class="btn ghost">ุงูุชุญ ููุชุจุฉ ุงูุฃุตูุงู</button>
          </div>
        </div>

        <!-- ุฌุฏูู ุงููุฌุจุฉ -->
        <div>
          <h3 style="margin:0 0 10px;">ูุฌุจุฉ ุงูููู</h3>
          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>ุงูุตูุฑุฉ</th>
                  <th>ุงูุตูู</th>
                  <th>ุงููุญุฏุฉ</th>
                  <th>ุงููููุฉ</th>
                  <th>ุฌุฑุงู</th>
                  <th>ูุงุฑุจ (raw)</th>
                  <th>ุฃููุงู</th>
                  <th>GI</th>
                  <th>GL</th>
                  <th>ุญุฐู</th>
                </tr>
              </thead>
              <tbody id="mealBody"></tbody>
            </table>
          </div>

          <div class="totals">
            <div class="total">GL (total): <b id="sumGL">0</b></div>
            <div class="total">โGI (avg): <b id="sumGI">โ</b></div>
            <div class="total">Calories: <b id="sumCal">0</b> kcal</div>
            <div class="total">Net Carbs: <b id="sumCarbsNet">0</b> g</div>
            <div class="total">Fiber: <b id="sumFiber">0</b> g</div>
            <div class="total">Carbs (raw): <b id="sumCarbsRaw">0</b> g</div>
            <div class="total dose">ุงูุฌุฑุนุฉ ุงูููุงุฆูุฉ: <span id="doseTotal">โ</span> U</div>
          </div>

          <div class="toolbar" style="margin-top:10px;">
            <button id="btnSaveMeal" class="btn">ุญูุธ ุงููุฌุจุฉ</button>
            <button id="btnSaveTemplate" class="btn ghost">ุญูุธ ููุงูุจ</button>
            <button id="btnLoadTemplates" class="btn ghost">ุงุณุชูุฑุงุฏ ูู ุงูููุงูุจ</button>
            <button id="btnExportCSV" class="btn ghost">ุชุตุฏูุฑ (CSV)</button>
            <button id="btnPrint" class="btn ghost">PDF ุชุตุฏูุฑ</button>
            <button id="btnSaveFavorites" class="btn ghost">ุญูุธ ุงูููุถูุฉ/ุบูุฑ ุงูููุถูุฉ</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ูุงูุฐุฉ ููุชุจุฉ ุงูุฃุตูุงู (Modal) -->
  <div id="libModal" class="modal hidden" aria-hidden="true">
    <div class="modal__overlay" data-close-modal></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="libTitle">
      <div class="modal__header">
        <div>
          <div id="libTitle" class="modal__title">ููุชุจุฉ ุงูุฃุตูุงู</div>
          <div class="muted">ุงุจุญุซ ุจุงูุงุณู โข ุฑุดูุญ ุจุงูููุถูุฉ โข ูู ุตูู ููู GI/GL ูุจูุงูุงุช 100ุฌู</div>
        </div>
        <button class="modal__close" data-close-modal>โ</button>
      </div>

      <div class="modal__toolbar">
        <input id="searchBox" type="search" placeholder="โฆ ุงุจุญุซ ุจุงุณู ุงูุตูู" />
        <div class="chips">
          <div class="chip">ููุถูู: โญ</div>
          <div class="chip">ุบูุฑ ููุถูู: ๐ซ</div>
          <div class="chip">ุงูุนุฏุฏ: <b id="itemsCount">0</b></div>
        </div>
      </div>

      <div id="itemsGrid" class="items-grid"></div>
    </div>
  </div>

  <!-- ุชููุฆุฉ Firebase ูุจู meals.js -->
  <script type="module">
    import { getApps, initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    async function ensureFirebase(){
      if (window._db && window._st) return;
      try {
        const confMod = await import('./js/firebase-config.js');
        if (confMod.app && confMod.db && confMod.storage) {
          // ุญุงูุชู ุงููุฏููุฉ ูุงูุช ุจุชุตุฏูุฑ { app, auth, db, storage }
          window._app = confMod.app;
          window._db  = confMod.db;
          window._st  = confMod.storage;
        } else if (confMod.firebaseConfig) {
          const apps = getApps();
          const app = apps.length ? apps[0] : initializeApp(confMod.firebaseConfig);
          window._app = app;
          window._db  = getFirestore(app);
          window._st  = getStorage(app);
        }
      } catch (e) {
        // fallback ุฅูู window.firebaseConfig ูู ููุฌูุฏ
        if (window.firebaseConfig) {
          const apps = getApps();
          const app = apps.length ? apps[0] : initializeApp(window.firebaseConfig);
          window._app = app;
          window._db  = getFirestore(app);
          window._st  = getStorage(app);
        }
      }
      if (!window._db || !window._st) {
        alert("Firebase not initialized. ุชุฃูุฏู ูู ุณูุฑุจุช ุงูุชููุฆุฉ ูุจู meals.js");
        throw new Error("Firebase not initialized");
      }
    }
    await ensureFirebase();
  </script>

  <!-- ููุทู ุงูุตูุญุฉ -->
  <script type="module" src="js/meals.js"></script>
</body>
</html>
