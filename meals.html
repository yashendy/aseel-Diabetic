<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>الوجبات</title>
  <link rel="icon" href="favicon.ico">
  <link rel="stylesheet" href="css/meals.css">
</head>
<body>

  <!-- Loader -->
  <div id="appLoader" class="loader">
    <span class="spinner"></span>
    <span>يجري التحميل...</span>
  </div>

  <main class="container">
    <div class="topbar">
      <a id="btnBack" class="btn-link" href="#">رجوع لصفحة الطفل</a>
      <div class="chips">
        <span id="chipCF" class="chip">— CF</span>
        <span id="chipCR" class="chip">— CR</span>
        <span id="chipTargets" class="chip">— الهدف</span>
      </div>
    </div>

    <section class="grid-2">
      <!-- لوحة اليوم -->
      <div class="panel">
        <h3>لوحة اليوم</h3>

        <div class="row">
          <label>الوجبة</label>
          <select id="slotSelect">
            <option value="b">فطار</option>
            <option value="l">غدا</option>
            <option value="d">عشا</option>
            <option value="s">سناك</option>
          </select>
        </div>

        <div class="row">
          <label>تاريخ الوجبة</label>
          <input id="dateInput" type="date" />
        </div>

        <div class="row">
          <label>وقت الوجبة (ربط القياس)</label>
          <input id="mealTime" type="time" step="60" />
        </div>

        <div class="row">
          <label>(mmol/L) قراءة قبل الوجبة</label>
          <input id="preBg" type="number" step="0.1" inputmode="decimal" />
          <button id="btnFetchPre" class="btn sm">جلب تلقائي</button>
        </div>

        <div class="row">
          <label>قاعدة صافي الكارب</label>
          <select id="netCarbRule">
            <option value="none">بدون خصم الألياف</option>
            <option value="halfFiber">خصم نصف الألياف</option>
            <option value="fullFiber">خصم كامل الألياف</option>
          </select>
        </div>

        <div class="row"><label>جرعة التصحيح (U)</label><input id="doseCorrection" type="number" step="0.1" /></div>
        <div class="row"><label>جرعة الكارب (U)</label><input id="doseCarbs" type="number" step="0.1" /></div>

        <div class="row">
          <label>إجمالي كارب اليوم: g</label>
          <input id="dayCarbs" type="number" step="1" />
        </div>

        <div class="row">
          <div class="progress"><div id="progressBar" class="bar" style="width:0%"></div></div>
        </div>

        <div class="row right">
          <button id="btnScaleToTarget" class="btn">اضبط للوصول للهدف</button>
          <button id="btnClearMeal" class="btn gray">مسح</button>
          <button id="btnOpenLibrary" class="btn alt">افتح مكتبة الأصناف</button>
        </div>
      </div>

      <!-- وجبة اليوم -->
      <div class="panel">
        <h3>وجبة اليوم</h3>

        <table class="meal-table" id="mealTable">
          <thead>
            <tr>
              <th>حذف</th>
              <th>GL</th>
              <th>GI</th>
              <th>ألياف</th>
              <th>Net Carbs</th>
              <th>(raw) كارب</th>
              <th>Calories</th>
              <th>جرام</th>
              <th>الوحدة</th>
              <th>الصنف</th>
              <th>الصورة</th>
            </tr>
          </thead>
          <tbody id="mealBody">
            <tr class="empty"><td colspan="11" style="text-align:center;color:#888">—</td></tr>
          </tbody>
          <tfoot>
            <tr>
              <td></td>
              <td id="sumGL">0</td>
              <td id="sumGI">—</td>
              <td id="sumFiber">0 g</td>
              <td id="sumCarbsNet">0 g</td>
              <td id="sumCarbsRaw">0 g</td>
              <td id="sumCalories">0 kcal</td>
              <td colspan="4">
                <span>U — الجرعة النهائية:</span>
                <strong id="doseFinal">0</strong>
              </td>
            </tr>
          </tfoot>
        </table>

        <div class="row wrap">
          <button id="btnSaveMeal" class="btn primary">حفظ الوجبة</button>
          <button id="btnSaveTemplate" class="btn">حفظ كقالب</button>
          <button id="btnLoadTemplates" class="btn">استيراد من القوالب</button>
          <button id="btnExportCSV" class="btn">تصدير (CSV)</button>
          <button id="btnPrint" class="btn">تصدير PDF</button>
          <button id="btnSaveFavorites" class="btn gray">حفظ/استبعاد غير المفضلة</button>
        </div>
      </div>
    </section>
  </main>

  <!-- نافذة مكتبة الأصناف -->
  <div id="libModal" class="lib-modal">
    <div id="libOverlay" class="lib-overlay" data-close></div>
    <div class="lib-panel">
      <div class="lib-header">
        <h4>مكتبة الأصناف</h4>
        <button id="libClose" class="lib-close" data-close>×</button>
      </div>
      <div class="lib-actions">
        <input id="searchBox" class="input" type="search" placeholder="ابحث عن صنف..." />
      </div>
      <div id="itemsGrid" class="grid"></div>
    </div>
  </div>

  <!-- سكربت واحد فقط -->
  <script type="module" src="js/meals.js"></script>
</body>
</html>
