<!-- /meals.html -->
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ุงููุฌุจุงุช</title>

  <link rel="stylesheet" href="css/meals.css" />
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- ุดุนุงุฑุงุช ุงูููุตุฉ -->
  <link rel="icon" href="favicon.ico">
  <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
  <header class="app-header">
    <div class="child-meta">
      <div class="child-name" id="childName">โ</div>
      <div class="chips">
        <span class="chip" id="chipCF">CF โ</span>
        <span class="chip" id="chipCR">CR โ</span>
        <span class="chip ghost" id="chipTargets">ูุฏู 7 (3.9โ10.9)</span>
      </div>
    </div>
    <nav class="app-actions">
      <a class="btn ghost" id="backToChild">ุฑุฌูุน ูุตูุญุฉ ุงูุทูู</a>
    </nav>
  </header>

  <main class="container">
    <!-- ููุญุฉ ุงูููู -->
    <section class="card">
      <h2>ููุญุฉ ุงูููู</h2>
      <div class="grid2">
        <label class="fld">
          <span>ุชุงุฑูุฎ ุงููุฌุจุฉ</span>
          <input type="date" id="dateInput" />
        </label>
        <label class="fld">
          <span>ุงููุฌุจุฉ</span>
          <select id="slotSelect">
            <option value="b">ูุทุงุฑ</option>
            <option value="l">ุบุฏุงุก</option>
            <option value="d">ุนุดุงุก</option>
            <option value="s">ุณูุงู</option>
          </select>
        </label>

        <label class="fld">
          <span>ููุช ุงููุฌุจุฉ (ูุฑุจุท ุงูููุงุณ)</span>
          <input type="time" id="mealTime" />
        </label>

        <div class="fld">
          <span>ูุฑุงุกุฉ ูุจู ุงููุฌุจุฉ (mmol/L)</span>
          <div class="inline">
            <input type="number" id="preBg" step="0.1" placeholder="โ" />
            <button class="btn" id="btnFetchPre">ุฌูุจ ุชููุงุฆู</button>
          </div>
          <small id="preBgHint" class="hint">ูุจุญุซ ุฃููุงู ุนู PRE_{SLOT} ุซู ุฃูุฑุจ ูุฑุงุกุฉ ุฎูุงู 90 ุฏูููุฉ ูุจู ููุช ุงููุฌุจุฉ.</small>
        </div>

        <label class="fld">
          <span>ุฌุฑุนุฉ ุงูุชุตุญูุญ (U)</span>
          <input type="number" id="doseCorrection" step="0.1" />
          <small class="hint">ุฅุฐุง BG &gt; 10.9: (BG โ 7) รท CFุ ูุน ุงูุชูุฑูุจ ูุฃูุฑุจ 0.5U.</small>
        </label>

        <label class="fld">
          <span>ูุงุนุฏุฉ ุตุงูู ุงููุงุฑุจ</span>
          <select id="netCarbRule">
            <option value="none">ุจุฏูู ุฎุตู ุฃููุงู</option>
            <option value="halfFiber">ุฎุตู ูุตู ุงูุฃููุงู</option>
            <option value="fullFiber">ุฎุตู ูุงูู ุงูุฃููุงู</option>
          </select>
        </label>

        <label class="fld">
          <span>ุฌุฑุนุฉ ุงููุงุฑุจ (U)</span>
          <input type="number" id="doseCarbs" step="0.1" />
        </label>

        <div class="fld">
          <span>ุงูุฌุฑุนุฉ ุงูููุงุฆูุฉ (U)</span>
          <div class="total dose"><span id="doseTotal">โ</span></div>
        </div>

        <div class="fld">
          <span>ุฅุฌูุงูู ูุงุฑุจ ุงูููู</span>
          <div class="total"><span id="dayCarbs">โ</span> g</div>
        </div>
      </div>
    </section>

    <!-- ููุชุจุฉ ุงูุฃุตูุงู + ุฌุฏูู ุงููุฌุจุฉ -->
    <section class="grid-left">
      <div class="card">
        <div class="flex-between">
          <h2>ููุชุจุฉ ุงูุฃุตูุงู</h2>
          <div class="toolbar">
            <input id="searchBox" placeholder="ุงุจุญุซ ุจุงุณู ุงูุตููโฆ" />
          </div>
        </div>
        <div class="legend">
          <span>โญ ููุถูู</span>
          <span>๐ซ ุบูุฑ ููุถูู</span>
          <span>GI: ูุคุดุฑ โข GL: ุญูู</span>
        </div>
        <div id="itemsGrid" class="items-grid"></div>
        <div class="flex-between">
          <div>
            <button class="btn ghost" id="btnLoadTemplates">ุงุณุชูุฑุงุฏ ูู ุงูููุงูุจ</button>
          </div>
          <div class="muted" id="itemsCount"></div>
        </div>
      </div>

      <div class="card">
        <div class="flex-between">
          <h2>ูุฌุจุฉ ุงูููู</h2>
          <div class="toolbar">
            <button class="btn" id="btnScaleToTarget">ุงุถุจุท ูููุตูู ูููุฏู</button>
            <button class="btn danger ghost" id="btnClearMeal">ูุณุญ</button>
          </div>
        </div>

        <div class="progress">
          <div class="bar" id="progressBar" style="width:0%"></div>
          <div class="progress-label" id="progressLabel">0 / โ g</div>
        </div>

        <div class="table-wrap">
          <table class="table" id="mealTable">
            <thead>
              <tr>
                <th>ุงูุตูุฑุฉ</th><th>ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th>
                <th>ุฌู</th><th>ูุงุฑุจ</th><th>ุฃููุงู</th><th>GI</th><th>GL</th><th></th>
              </tr>
            </thead>
            <tbody id="mealBody"></tbody>
            <tfoot>
              <tr>
                <td colspan="10">
                  <div class="totals">
                    <div>Carbs (raw): <b id="sumCarbsRaw">0</b> g</div>
                    <div>Fiber: <b id="sumFiber">0</b> g</div>
                    <div>Net Carbs: <b id="sumCarbsNet">0</b> g</div>
                    <div>Calories: <b id="sumCal">0</b> kcal</div>
                    <div>GI (avg): <b id="sumGI">โ</b></div>
                    <div>GL (total): <b id="sumGL">0</b></div>
                  </div>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="flex-between">
          <div class="left">
            <button class="btn ghost" id="btnSaveFavorites">ุญูุธ ุงูููุถูุฉ/ุบูุฑ ุงูููุถูุฉ</button>
            <button class="btn ghost" id="btnSaveTemplate">ุญูุธ ููุงูุจ</button>
          </div>
          <div class="right">
            <button class="btn ghost" id="btnExportCSV">ุชุตุฏูุฑ Excel (CSV)</button>
            <button class="btn ghost" id="btnPrint">ุชุตุฏูุฑ PDF</button>
            <button class="btn primary" id="btnSaveMeal">ุญูุธ ุงููุฌุจุฉ</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ุชููุฆุฉ Firebase ูุฑูุฉ (ุชุนูู ูุน ุฃู ุดูู ูููู firebase-config.js) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const mod = await import("./js/firebase-config.js");

    // 1) ูู ุงูููู ุตุฏูุฑ app/db/st ูุจุงุดุฑุฉ
    let app = mod.app || window._app || null;
    let db  = mod.db  || window._db  || null;
    let st  = mod.st  || window._st  || null;

    // 2) ุฃู ูู ุตุฏูุฑ firebaseConfig
    if (!app && (mod.firebaseConfig || mod.default || window.firebaseConfig)) {
      const cfg = mod.firebaseConfig || mod.default || window.firebaseConfig;
      app = initializeApp(cfg);
    }

    // 3) ูููู ุงูู db/storage ูู ูุงูุตูู
    if (app && !db) db = getFirestore(app);
    if (app && !st) st = getStorage(app);

    // 4) ูููุฑูู ูู meals.js
    window._app = app;
    window._db  = db;
    window._st  = st;
  </script>

  <!-- ููุทู ุงูุตูุญุฉ -->
  <script type="module" src="js/meals.js"></script>
</body>
</html>
