<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>وجبة الطفل</title>
  <link rel="stylesheet" href="./css/meals.css" />
</head>
<body>

  <header class="page-header">
    <div class="left">
      <button id="btnBack" class="btn ghost">⬅︎ رجوع</button>
      <a href="./child.html" class="btn ghost">🏠 الرئيسية</a>
    </div>
    <div class="title">
      <h1>وجبة الطفل <span id="childName" class="chip chip-soft">—</span></h1>
      <div class="chips">
        <span id="chipUnit" class="chip">وحدة: —</span>
        <span id="chipCR" class="chip">CR: —</span>
        <span id="chipCF" class="chip">CF: —</span>
      </div>
    </div>
    <div class="right"></div>
  </header>

  <section class="toolbar">
    <div class="field">
      <label>نوع الوجبة</label>
      <select id="mealType">
        <option value="فطار">فطار</option>
        <option value="غدا">غدا</option>
        <option value="عشا">عشا</option>
        <option value="سناك">سناك</option>
      </select>
    </div>

    <div class="field">
      <label>تاريخ</label>
      <input id="mealDate" type="date" />
    </div>

    <div class="field">
      <label>إجراءات سريعة</label>
      <div class="row gap">
        <button id="btnAddFromLib" class="btn">+ إضافة صنف من المكتبة</button>
        <button id="btnAddFromPreset" class="btn ghost">📦 من قالب</button>
        <button id="btnSaveAsPreset" class="btn ghost">⭐ حفظ كوجبة جاهزة</button>
      </div>
    </div>
  </section>

  <section class="metrics-card card">
    <div class="metrics-grid">
      <div class="field">
        <label>قياس قبل الوجبة</label>
        <input id="preReading" type="number" step="0.1" inputmode="decimal" placeholder="—" />
      </div>
      <div class="field">
        <label>قياس بعد الوجبة</label>
        <input id="postReading" type="number" step="0.1" inputmode="decimal" placeholder="—" />
      </div>

      <div class="field">
        <label>جرعة التصحيح</label>
        <input id="doseCorrection" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>
      <div class="field">
        <label>جرعة الكارب (مقترحة)</label>
        <input id="doseCarb" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>

      <div class="field">
        <label>إجمالي الجرعة</label>
        <input id="doseTotal" type="number" step="0.1" inputmode="decimal" value="0" />
      </div>

      <div class="field">
        <label>ملاحظات (اختياري)</label>
        <input id="notes" type="text" placeholder="مثال: وجبة خفيفة" />
      </div>
    </div>

    <div id="hintLine" class="hint-line">
      <span id="hintCf" class="muted">⚠️ رجاء ضبط CF (معامل التصحيح) في بيانات الطفل.</span>
      <span id="hintCr" class="muted">⚠️ رجاء ضبط CR (معامل الكارب) في بيانات الطفل.</span>
      <span id="hintAuto" class="muted">✅ تم جلب القياس تلقائيًا إذا توفر.</span>
    </div>
  </section>

  <section class="targets card">
    <div class="targets-head">
      <div>
        <strong>هدف الكارب للوجبة:</strong>
        <span id="targetText" class="chip chip-soft">—</span>
      </div>
      <div class="row gap">
        <button id="btnAdjustToTarget" class="btn small">🎯 ضبط للهدف</button>
        <button id="btnSmartDistribute" class="btn small ghost">🔀 توزيع ذكي</button>
      </div>
    </div>
    <div class="progress">
      <div id="progressFill"></div>
    </div>
    <div class="progress-caption">
      <span>الكارب الحالي: <b id="netCarb">0</b> g</span>
      <span>السعرات: <b id="totalCal">0</b> kcal</span>
      <span>بروتين: <b id="totalProt">0</b> g</span>
      <span>دهون: <b id="totalFat">0</b> g</span>
    </div>
  </section>

  <section class="card">
    <div class="table-head">
      <div class="th th-actions">—</div>
      <div class="th th-name">الصنف</div>
      <div class="th th-est">التقدير البيتي</div>
      <div class="th th-qty">الكمية</div>
      <div class="th th-grams">الجرامات (g)</div>
      <div class="th">كارب (g)</div>
      <div class="th">بروتين (g)</div>
      <div class="th">دهون (g)</div>
      <div class="th">سعرات (kcal)</div>
    </div>
    <div id="itemsBody" class="items-body"></div>
    <div class="table-foot">
      <div class="sum">الإجمالي: كارب <b id="sumCarb">0</b> • بروتين <b id="sumProt">0</b> • دهون <b id="sumFat">0</b> • سعرات <b id="sumCal">0</b></div>
    </div>
  </section>

  <section class="save-row">
    <div class="row gap">
      <button id="btnSaveMeal" class="btn primary">💾 حفظ الوجبة</button>
      <button id="btnReset" class="btn ghost">↺ إعادة الضبط</button>
    </div>
  </section>

  <!-- مكتبة الأصناف -->
  <dialog id="dlgLibrary" class="modal">
    <div class="modal-head">
      <h3>اختيار صنف من المكتبة</h3>
      <button class="icon" data-close>✕</button>
    </div>
    <div class="modal-tools">
      <input id="libSearch" type="search" placeholder="بحث بالاسم أو #هاشتاج…" />
      <label class="chk"><input id="fltLiked" type="checkbox" /> ❤️ فقط المفضلة</label>
      <label class="chk"><input id="fltHideDiet" type="checkbox" checked /> إخفاء المخالف للنظام ⚠️</label>
      <label class="chk"><input id="fltHideAllergy" type="checkbox" checked /> إخفاء الحساسية 🚫</label>
    </div>
    <div id="libGrid" class="grid"></div>
  </dialog>

  <!-- القوالب -->
  <dialog id="dlgPresets" class="modal">
    <div class="modal-head">
      <h3>قوالب الوجبات</h3>
      <button class="icon" data-close>✕</button>
    </div>
    <div id="presetsList" class="grid"></div>
  </dialog>

  <!-- المساعد الذكي -->
  <button id="btnAssistant" class="assistant-fab">💬</button>
  <div id="assistantPanel" class="assistant hidden">
    <div class="assistant-head">
      <strong>المساعد الذكي</strong>
      <button id="assistantClose" class="icon">✕</button>
    </div>
    <div id="assistantBody" class="assistant-body"></div>
    <div class="assistant-foot">
      <button class="btn small" data-ask="هل أحتاج جرعة تصحيح؟">هل أحتاج تصحيح؟</button>
      <button class="btn small" data-ask="كيف أوصل لهدف الوجبة؟">كيف أوصل لهدفي؟</button>
      <button class="btn small" data-ask="هل في مخالفة أو حساسية؟">المخالف/الحساسية؟</button>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <!-- Firebase (modular CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged as modOnAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // محرك تهيئة مرن: __FB جاهزة ← نستخدمها، أو firebaseConfig موجود ← نهيّئ،
    // أو compat موجود ← نستخدمه، وإلا نعرض رسالة لطيفة بدل الكراش.
    let app, auth, db, storage, onAuthStateChanged;

    const useFromWindow = () => {
      app = window.__FB?.app; auth = window.__FB?.auth;
      db = window.__FB?.db; storage = window.__FB?.storage;
      onAuthStateChanged = window.__FB?.onAuthStateChanged || modOnAuth;
      return Boolean(app && auth && db && storage);
    };

    const tryConfig = () => {
      const cfg = window.firebaseConfig || window.FIREBASE_CONFIG;
      if(!cfg) return false;
      app = initializeApp(cfg);
      auth = getAuth(app); db = getFirestore(app); storage = getStorage(app);
      onAuthStateChanged = modOnAuth;
      return true;
    };

    const tryCompat = () => {
      const f = window.firebase;
      if(!f || !f.apps || !f.apps.length) return false;
      app = f.app(); auth = f.auth(); db = f.firestore(); storage = f.storage();
      onAuthStateChanged = (a, cb)=> auth.onAuthStateChanged(cb);
      return true;
    };

    if(!useFromWindow() && !tryConfig() && !tryCompat()){
      console.error("Firebase config غير متوفر. رجاء تضمين firebaseConfig أو __FB أو compat.");
    }

    window.__FB = { app, auth, db, storage, onAuthStateChanged };
  </script>

  <script type="module" src="./js/meals.js"></script>
</body>
</html>
